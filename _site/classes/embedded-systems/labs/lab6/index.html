<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Lab 6 | HThreads</title><meta name="generator" content="Jekyll v3.9.3" /><meta property="og:title" content="Lab 6" /><meta name="author" content="Kevin Lin" /><meta property="og:locale" content="en_US" /><meta name="description" content="A modern, highly customizable, responsive Jekyll template for course websites" /><meta property="og:description" content="A modern, highly customizable, responsive Jekyll template for course websites" /><link rel="canonical" href="http://localhost:4000/classes/embedded-systems/labs/lab6/" /><meta property="og:url" content="http://localhost:4000/classes/embedded-systems/labs/lab6/" /><meta property="og:site_name" content="HThreads" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Lab 6" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Kevin Lin"},"description":"A modern, highly customizable, responsive Jekyll template for course websites","headline":"Lab 6","url":"http://localhost:4000/classes/embedded-systems/labs/lab6/"}</script><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewBox="0 0 16 16"><title>Copy</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"><title>Copied</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="/" class="site-title lh-tight"> HThreads </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Classes category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/classes/" class="nav-list-link">Classes</a><ul class="nav-list"><li class="nav-list-item "><a href="#" class="nav-list-expander" aria-label="toggle links in EECS 4213 Computer Architecture category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/classes/computer-architecture/" class="nav-list-link">EECS 4213 Computer Architecture</a><ul class="nav-list"><li class="nav-list-item "> <a href="/classes/computer-architecture/syllabus/" class="nav-list-link">Syllabus</a><li class="nav-list-item "> <a href="/classes/computer-architecture/schedule/" class="nav-list-link">Schedule</a></ul><li class="nav-list-item "><a href="#" class="nav-list-expander" aria-label="toggle links in EECS 4114 Embedded Systems category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/classes/embedded-systems/" class="nav-list-link">EECS 4114 Embedded Systems</a><ul class="nav-list"><li class="nav-list-item "> <a href="/classes/embedded-systems/syllabus/" class="nav-list-link">Syllabus</a><li class="nav-list-item "> <a href="/classes/embedded-systems/schedule/" class="nav-list-link">Schedule</a><li class="nav-list-item "> <a href="/classes/embedded-systems/labs/" class="nav-list-link">Labs</a></ul></ul><li class="nav-list-item"><a href="/people/" class="nav-list-link">People</a><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Projects category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/projects/" class="nav-list-link">Projects</a><ul class="nav-list"><li class="nav-list-item "><a href="/projects/picaso/" class="nav-list-link">PiCaSO</a></ul><li class="nav-list-item"><a href="/publications/" class="nav-list-link">Publications</a><li class="nav-list-item"><a href="/schedule/" class="nav-list-link">Schedule</a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search HThreads" aria-label="Search HThreads" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"> <a href="/classes/">Classes</a><li class="breadcrumb-nav-list-item"> <a href="/classes/embedded-systems/">EECS 4114 Embedded Systems</a><li class="breadcrumb-nav-list-item"> <a href="/classes/embedded-systems/labs/">Labs</a><li class="breadcrumb-nav-list-item"> <span>Lab 6</span></ol></nav><div id="main-content" class="main-content" role="main"><h1 id="lab-6-bare-metal-task-control-blocks-tcbs"> <a href="#lab-6-bare-metal-task-control-blocks-tcbs" class="anchor-heading" aria-labelledby="lab-6-bare-metal-task-control-blocks-tcbs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Lab 6: Bare Metal Task Control Blocks (TCBs)</h1><p><em>â€“An Introduction to FreeRTOS-like Programming:</em></p><p>The goal of this lab is to become familiar with the concept of pseudo-multitasking on microprocessors (which typically only have a single core) using a stripped down version of a real-time operating system, or RTOS. You will use the MicroBlaze system from past labs that includes timer interrupts, and a structure to organize the tasks we want to process, called a task control block. These components form the basis for a non-preemptive round-robin RTOS. This RTOS will be adapted for our Fayetteville bike trail crossing traffic signal to work with this paradigm.</p><h2 id="lab-directions"> <a href="#lab-directions" class="anchor-heading" aria-labelledby="lab-directions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Lab Directions</h2><p>For this lab we will be using the same SoC design from previous labs. The code you will be running can be found here File:Tasks.c.</p><h2 id="project-instructions"> <a href="#project-instructions" class="anchor-heading" aria-labelledby="project-instructions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Project Instructions</h2><p>Start off with your Lab 5 project. That project has all the necessary working components to get our task scheduler working. Your job for this lab is to study how your original code was restructured to form a round-robin scheduler. The following section outlines the highlights. It is important that you understand how the FSMs of the previous labs were broken up into scheduled tasks that are then managed by the simple task scheduler.</p><p class="note">The scheduler is kicked off by the timer at a set interval. The Linux scheduler calls this a jiffy, while other RTOSâ€™s refer to this as a timer tick. The code provided in this lab will form the basis for the code you will develop on your own next week using FreeRTOSâ„¢.</p><h2 id="understanding-the-code"> <a href="#understanding-the-code" class="anchor-heading" aria-labelledby="understanding-the-code"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Understanding the code</h2><ol><li>The body of <code class="language-plaintext highlighter-rouge">main()</code> puts all the Interrupt Controller and Timer module related function calls in a function called <code class="language-plaintext highlighter-rouge">init()</code>.<li>The timer is modified such that it fires an interrupt every 5ms.<li>A struct serving as a basic task control block (TCB) holds the following information:<ul><li><code class="language-plaintext highlighter-rouge">taskPtr</code> - this is a function pointer. It has a void return type and a void pointer parameter it can accept.<li><code class="language-plaintext highlighter-rouge">taskDataPtr</code> - A void pointer that can be used to pass the function pointer as a parameter.<li><code class="language-plaintext highlighter-rouge">taskReady</code> - Implemented as a boolean or a char. This determines if the scheduler will run our task or skip over it.</ul><li>Now, because we are going to be translating our FSM-based implementation over to the RTOS we are building, we create functions that equate the actions of our FSM. There are several ways to go about doing this. For example, we could have one task manage the FSM logic, another task manage the RGB LED display, and another interface with the timer, giving us 3 tasks. But to provide us with a bit more variety, 5 tasks are created for this lab:<ul><li><code class="language-plaintext highlighter-rouge">taskChoose</code> - This is our first and highest priority task that determines which of the rest of the tasks need to be marked as ready or not. This is accomplished with a <code class="language-plaintext highlighter-rouge">switch</code> statement that evaluates the current state and sets the necessary <code class="language-plaintext highlighter-rouge">taskReady</code> flag for the following statesâ€¦<li><code class="language-plaintext highlighter-rouge">taskGreen</code> - Contains the green state related code.<li><code class="language-plaintext highlighter-rouge">taskRedBlinkStart</code> - Contains the first blinking state related code.<li><code class="language-plaintext highlighter-rouge">taskRedSolid</code> - Contains the solid red state related code.<li><code class="language-plaintext highlighter-rouge">taskRedBlinkEnd</code> - Contains the ending blinking state related code.</ul><li>Now that it is established that we have 5 tasks, a global array of 5 task (TCB) pointers is created.<li><p>Inside <code class="language-plaintext highlighter-rouge">main()</code>, prior to the infinite loop, we need to allocate memory for these pointers (using <code class="language-plaintext highlighter-rouge">malloc</code>) and initialize the TCBs with the function pointers, data parameter and status info. You can use the arrow operator (e.g. <code class="language-plaintext highlighter-rouge">task-&gt;</code>) to set these values.</p><blockquote class="note-title"><p>Aside:</p><p>The entries in the <code class="language-plaintext highlighter-rouge">enum</code> of tasks were created in the order they are implemented into the TCB queue as it serves as an explicit way to address which task you are dealing with. (e.g.: <code class="language-plaintext highlighter-rouge">queue[1]-&gt;taskPtr = ...</code> vs <code class="language-plaintext highlighter-rouge">queue[TASK_GREEN]-&gt;taskPtr = ...</code>)</p></blockquote><li>Before moving on to creating a task scheduler in the infinite loop, create a counter variable in <code class="language-plaintext highlighter-rouge">main()</code> starting at zero.<li>Timer interrupt handler. Now contains <code class="language-plaintext highlighter-rouge">queue[TASK_CHOOSE]-&gt;taskReady = TRUE;</code>. This will ensure that the FSM logic will be called with every single tick of the RTOS.<li>Inside an empty <code class="language-plaintext highlighter-rouge">while(1)</code> loop now, we continuously cycle through the tasks (0-4) in order and execute the ones marked as ready, passing in the taskâ€™s data pointer. E.g.: <code class="language-plaintext highlighter-rouge">if(queue[i]-&gt;taskReady) {...}</code><li>It is important to note the <code class="language-plaintext highlighter-rouge">taskReady</code> parameter is not automatically set to false when being executed in our system. Keeping this value true will mean the function will execute every single complete cycle of the scheduler.</ol><p class="info">Some material covered in this lab was borrowed from Dr. Nelsonâ€™s slides on real-time operating systems, specifically the stripped-down implementation of a task control block. To read about the material in context, check out <a href="http://csce.uark.edu/~ahnelson/CSCE4114/lectures/lecture14.pdf">slides 38-40 here</a>.</p><h2 id="submission"> <a href="#submission" class="anchor-heading" aria-labelledby="submission"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Submission</h2><p>Why stop nowâ€¦ Nothing due next week! ðŸ™‚</p><h2 id="prelab"> <a href="#prelab" class="anchor-heading" aria-labelledby="prelab"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prelab</h2><p>None! Letâ€™s take it easy this weekâ€¦ ðŸ™‚</p><h2 id="references"> <a href="#references" class="anchor-heading" aria-labelledby="references"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> References</h2><ol><li><a href="https://www.xilinx.com/support/documentation/ip_documentation/axi_timer/v2_0/pg079-axi-timer.pdf">AXI Timer Documentation</a><li><a href="https://www.xilinx.com/support/documentation/ip_documentation/axi_intc/v4_1/pg099-axi-intc.pdf">AXI Interrupt Controller Documentation</a><li><a href="http://csce.uark.edu/~ahnelson/CSCE4114/lectures/lecture14.pdf">Dr. Nelsonâ€™s EECS 4114, Chapter 14 Slides</a></ol></div></div><div class="search-overlay"></div></div>
